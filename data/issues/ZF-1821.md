---
layout: issue
title: "Zend_Auth_Adapter_DbTable SQL incompatible with MS SQL Server"
id: ZF-1821
---

ZF-1821: Zend\_Auth\_Adapter\_DbTable SQL incompatible with MS SQL Server
-------------------------------------------------------------------------

 Issue Type: Bug Created: 2007-08-07T07:21:19.000+0000 Last Updated: 2009-12-30T13:50:50.000+0000 Status: Resolved Fix version(s): 
 Reporter:  Darby Felton (darby)  Assignee:  Ralph Schindler (ralph)  Tags: - Zend\_Auth
 
 Related issues: 
 Attachments: - [DBTable-portable-sqll.diff](/issues/secure/attachment/10670/DBTable-portable-sqll.diff)
 
### Description

Original message from [~rob]:

{quote} The SQL generated by Zend\_Auth\_Adapter\_DbTable::authenticate() creates the following SQL for MS SQL Server:

 
    <pre class="highlight">
        SELECT
            "users".*,
            "password" = 'aa46347de7c4529eb7a1ce163daaa197fd1f1a62'
                            AS zend_auth_credential_match
            FROM "users"
            WHERE
                ("username" = 'rob')


This doesn't work and creates the following error:

SQLSTATE[HY000]: General error: 10007 Incorrect syntax near the keyword 'AS'. [10007] (severity 5) [(null)]

I've attached the patch I've used to get it working. It removes functionality though as you can now no longer tell the difference between the user not being in the database and the password being wrong. Personally I don't need that, so I haven't fixed it as the only portable way I can think of requires another database call.

I'll leave it to an SQL expert to come up with a better solution that works across all supported databases.

Regards,

Rob... {quote}

 

 

### Comments

Posted by Rob Allen (rob) on 2007-08-07T07:48:58.000+0000

I've upped the priority as this is a show-stopper bug for Zend\_Auth on MS SQL Server at least.

It doesn't help that the Exception message that is raised doesn't actually tell you what the problem is, so you assume that it's a problem with your code when it isn't!

 

 

Posted by Marc Holzwarth (mholzwarth) on 2007-08-08T02:56:52.000+0000

Using CASE expression for password test may correct this problem.

AFAIK, most database implementations of CASE expression are ANSI SQL-92 compliant.

All sql queries below works on MSSQL :

 
    <pre class="highlight">
    zend_auth_credential_match = (CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END)


 
    <pre class="highlight">
    (CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END) AS zend_auth_credential_match


 
    <pre class="highlight">
    (CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END) zend_auth_credential_match


 

 

Posted by Ralph Schindler (ralph) on 2007-12-26T23:38:36.000+0000

Does anyone watching this issue have access to a MS-SQL server that they can test new adapters with? I do not have direct access to one, but would like to find a workable solution to this within the next week.

-ralph

 

 

Posted by Ralph Schindler (ralph) on 2007-12-27T18:09:50.000+0000

I implemented

 
    <pre class="highlight">
    (CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END) AS zend_auth_credential_match


in r7278

 

 

Posted by Ralph Schindler (ralph) on 2008-01-23T12:09:44.000+0000

Resolved in r7598

 

 

Posted by Euller (eullerbd) on 2009-09-18T07:27:08.000+0000

This list states that the problem has been solved, but I continue having problems on accessing the database Sql Server using Zend\_Auth. You have the implementation and Exception below.

I would like quoting that the fields on table are correct, I tested them using the database mysql.

Exception

The supplied parameters to Zend\_Auth\_Adapter\_DbTable failed to produce a valid sql statement, please check table and column names for validity.

Implementation

 
    <pre class="highlight">
    public function login($login, $senha) {     
            $authAdapter = new Zend_Auth_Adapter_DbTable ( 
            Zend_Registry::get ( 'database' ), 'user', 'email', 'password', 'SHA1(?)' );
            $authAdapter->setIdentity ( '' . $login . '' )->setCredential ( '' . $senha . '' );
            $auth = self::getInstance ();
            $result = $auth->authenticate ( $authAdapter );
            if ($result->isValid ()) {
                $data = $authAdapter->getResultRowObject ( null, 'senha' );
                $auth->getStorage ()->write ( $data );
                $auth->getIdentity ();
                return true;
            } else {
                return false;
            }
        }


 

 

Posted by Ralph Schindler (ralph) on 2009-12-30T13:50:50.000+0000

Can you echo out the SQL statement that is being generated? You can do this by adding echo'ing the $dbSelect->\_\_toString() from within the method Zend\_Auth\_Adapter\_DbTable::\_authenticateQuerySelect().

Additionally, attempt to var\_dump the Exception $e.

-ralph

 

 