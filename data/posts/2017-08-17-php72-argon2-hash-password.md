---
layout: post
title: Protecting passwords with Argon2 in PHP 7.2
date: 2017-08-17T15:14:00-05:00
author: Enrico Zimuel
url_author: https://www.zimuel.it
permalink: /blog/2017-08-08-php72-argon2-hash-password.html
categories:
- blog
- php
- security
- hash
- password

---

The new version of PHP 7.2 will be released at the [end of November 2017](https://wiki.php.net/todo/php72).
This version contains some interesting additions, including two new security
features: the support of the [Argon2](https://en.wikipedia.org/wiki/Argon2)
password hash algorithm and the *ext/sodium* extension for [libsodium](https://libsodium.org)
library.

With these new features PHP is the first programming language to adopt
[modern cryptography](https://dev.to/paragonie/php-72-the-first-programming-language-to-add-modern-cryptography-to-its-standard-library)
in its standard library.

In this article, we will show the usage of the Argon2 password hash algorithm.

## Installation of PHP 7.2

If you are reading this article before the general availability of 7.2, you need
to compile PHP to use that version. You can download the source code from
[this website](https://downloads.php.net/~pollita/). For instance, today 17th
August 2017, the last available version is 7.2.0 Beta 3 (file
`php-7.2.0beta3.tar.gz`).

Before compiling PHP, you need to install the [argon2](https://launchpad.net/ubuntu/+source/argon2)
library. If you are using a Debian/Ubuntu Linux distribution, you can run the
following command:

```bash
sudo apt install argon2 libargon2-0 libargon2-0-dev
```

To compile PHP, you need to extract the previous source code in a folder and run
the following commands:

```bash
./configure --with-password-argon2
make
make install
```

> Notice the usage of the option `--with-password-argon2` for including the
> support of the Argon2 algorithm.

This will install the PHP 7.2 as the default PHP on your system. If you do not
want to change the default PHP, you can omit the execution of the last command
`make install`. In this case, you will need to reference to PHP 7.2 using the
path of the folder installation.


## Argon2

Argon2 is a password-based key derivation function winner of the [Password Hashing Competition](https://password-hashing.net/)
in July 2015.

This function is an evolution of [bcrypt](https://en.wikipedia.org/wiki/Bcrypt)
and [scrypt](https://en.wikipedia.org/wiki/Scrypt) algorithms.

Argon2 provides security against brute force attacks using a predefined memory
size, CPU time, and degree of parallelism to prevent [GPU](https://it.wikipedia.org/wiki/Graphics_Processing_Unit)
attacks.

It uses 3 parameters that control the memory requires, the execution time and
the parallelism level.

There are two main versions of this algorithm: *Argon2i* and *Argon2d*.
*Argon2i* is the safest against [side-channel attacks](https://en.wikipedia.org/wiki/Side-channel_attack),
while *Argon2d* provides the highest resistance against [GPU](https://it.wikipedia.org/wiki/Graphics_Processing_Unit)
cracking attacks.

Argon2d is not suitable for password hashing and should be

PHP 7.2 adds the *Argon2i* support in the [Password Hashing Functions](http://php.net/manual/en/ref.password.php).


## Usage of Argon2i in PHP

The Argon2 support in PHP has been proposed by Charles R. Portwood II in [this RFC](https://wiki.php.net/rfc/argon2_password_hash).

The implemented algorithm in PHP is the Argon2i (v1.3) and it can be used as
parameter of the [password_hash()](http://php.net/manual/en/function.password-hash.php)
function. The syntax of `password_hash()` is as follows:

```php
string password_hash ( string $password , integer $algo [, array $options ] )
```

The second parameter (`$algo`) specifies the algorithm to use for the hashing.
The Argon2i algorithm is represented by the constant `PASSWORD_ARGON2I`.

Below is reported a code example:

```php
$password = 'test';
$hash = password_hash($password, PASSWORD_ARGON2I);
var_dump($hash);
```

The `$hash` result will contains a string of 98 characters as follows:

```
$argon2i$v=19$m=1024,t=2,p=2$TmxLemFoVnZFaEJuT1NyYg$4j2ZFDn1fVS70ZExmlJ33rXOinafcBXrp6A6grHEPkI
```

This string contains sub-string of parts, separated by dollar (`$`).
These parts are:

```
argon2i
v=19
m=1024,t=2,p=2
TmxLemFoVnZFaEJuT1NyYg
4j2ZFDn1fVS70ZExmlJ33rXOinafcBXrp6A6grHEPkI
```

The first part is the algorithm name (`argon2i`), the second is the Argon2i
version 19 (that is 13 in hexadecimal), the third part are the algorithm
parameters related to memory cost (in Kb), time cost and threads to be used
(parallelism).

The fourth parameter is the random salt value, encoded in [Base64](https://en.wikipedia.org/wiki/Base64).
This value is generated by the `password_hash()` using a random value for each
execution. This is why we have different hash outputs for the same string in
input. The default size of the salt is 16 bytes.

The last parts of the string contains the hash value, encoded in Base64. The
hash size is 32 bytes.

PHP offers a special function named [password_get_info($hash)](http://php.net/manual/en/function.password-get-info.php)
to get information about the hash generated by `password_hash()`. For instance,
if you use the `password_get_info()` on the previous value, you will get a
result as follows:

```php
array(3) {
  ["algo"]=>
  int(2)
  ["algoName"]=>
  string(7) "argon2i"
  ["options"]=>
  array(3) {
    ["memory_cost"]=>
    int(1024)
    ["time_cost"]=>
    int(2)
    ["threads"]=>
    int(2)
  }
}
```

The default parameters for the algorithm are a `memory_cost` of 1024 Kb (1 Mb),
a `time_cost` of 2 and two `threads` to be used for the parallelism. The Argon2
specifications suggest to use a power of 2 value for the `memory_cost`.

These values can be changed using the $options parameter of `password_hash()`
function. Below is reported an example:

```php
$password = 'test';
$options = [
    'memory_cost' => 1<<17, // 128 Mb
    'time_cost' => 4,
    'threads' => 3
];
$hash = password_hash($password, PASSWORD_ARGON2I, $options);
var_dump($hash);
```

PHP will generate an `E_WARNING` for values that cannot be used as options for
the `PASSWORD_ARGON2I` algorithm.

Regarding the default option values, we suggest to change it according to the
use cases and CPU + RAM available. From the [PHP RFC](https://wiki.php.net/rfc/argon2_password_hash#discussion_issues):

> Due to the variety of platforms PHP runs on, the cost factors are
> deliberately set low as to not accidentally exhaust system resources on shared
> or low resource systems when using the default cost parameters. Consequently,
> users should adjust the cost factors to match the system they're working on.
> As Argon2 doesn't have any “bad” values, however consuming more resources is
> considered better than consuming less. Users are encouraged to adjust the cost
> factors for the platform they're developing for.


## Conclusion

In this article we showed how to use the Argon2 password hash function with
PHP 7.2. The Argon2 algorithm is the state of the art for password protection
and it can be now used in PHP without installing additional extensions.
This is a very nice security feature that will improve the security of PHP
applications that use users' passwords. In a future article, we will introduce
also the `Sodium` extension, the other new security feature included in PHP 7.2.
With these new features, PHP is the first language to support *modern
cryptography* in the core of the language.
